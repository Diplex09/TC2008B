<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Mult-agent traffic simulation</title>
        <style>
            html,
            body {
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
                overflow: hidden;
            }
        </style>
    </head>
    <body>
        <script
            type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"
        ></script>
        <script type="module">
            import * as THREE from "https://unpkg.com/three/build/three.module.js";
            import Stats from "https://unpkg.com/three/examples/jsm/libs/stats.module.js";
            import { OrbitControls } from "https://unpkg.com/three@0.119.0/examples/jsm/controls/OrbitControls.js";
            import { OBJLoader } from "https://cdn.jsdelivr.net/npm/three@0.117.1/examples/jsm/loaders/OBJLoader.js";

            ("use strict");

            let renderer,
                scene,
                camera1,
                camera2,
                camera3,
                camera4,
                orbitControls,
                stats,
                gui,
                data,
                dataReady = false,
                frameCounter = 0,
                setVisible = false;
            let guiTrafficLightMenu;
            let pointLight;
            window.multiview = false;

            function init(event) {
                // RENDERER ENGINE
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setViewport(
                    0,
                    0,
                    window.innerWidth,
                    window.innerHeight
                );
                renderer.setClearColor(new THREE.Color(0, 0, 0));
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.setScissorTest(true);
                document.body.appendChild(renderer.domElement);

                // SCENE
                scene = new THREE.Scene();

                // MODELS
                const scenary = new Scenary();

                //LIGHTS
                pointLight = new PointLight();

                // SCENE GRAPH
                scene.add(scenary);
                scene.add(pointLight);

                // CAMERA (PERSPECTIVE)
                camera1 = new Camera();
                camera1.setPerspectiveView();
                camera2 = new Camera();
                camera2.setTopView();
                camera3 = new Camera();
                camera3.setSideView();
                camera4 = new Camera();
                camera4.setFrontView();

                // SETUP STATS
                stats = new Stats();
                stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
                document.body.appendChild(stats.dom);

                // GUI

                gui = new dat.GUI();
                // SCENE-MENU
                const guiSceneMenu = gui.addFolder("Scene Menu");
                guiSceneMenu
                    .add(scenary.axes, "visible")
                    .setValue(scenary.axes.visible)
                    .name("World Axes")
                    .listen()
                    .onChange(function (value) {
                        scenary.axes.setVisible(value);
                    });
                guiSceneMenu
                    .add(window, "multiview")
                    .setValue(window.multiview)
                    .name("Multiview")
                    .listen()
                    .onChange(function (value) {});
                guiSceneMenu
                    .add(scenary, "wireframeBool")
                    .setValue(scenary.wireframeBool)
                    .name("Wireframe")
                    .listen()
                    .onChange(function (value) {
                        scenary.setWireframeScene(value);
                    });

                guiSceneMenu.open();

                // CAMERA-MENU
                const guiCameraMenu = gui.addFolder("Camera Menu");
                guiCameraMenu
                    .add(camera1, "perspectiveView")
                    .name("Perspective View")
                    .listen()
                    .onChange(function () {
                        camera1.setPerspectiveView();
                    });
                guiCameraMenu
                    .add(camera1, "frontView")
                    .name("Front View")
                    .listen()
                    .onChange(function () {
                        camera1.setFrontView();
                    });
                guiCameraMenu
                    .add(camera1, "topView")
                    .name("Top View")
                    .listen()
                    .onChange(function () {
                        camera1.setTopView();
                    });
                guiCameraMenu
                    .add(camera1, "sideView")
                    .name("Side View")
                    .listen()
                    .onChange(function () {
                        camera1.setSideView();
                    });
                /*
                        guiCameraMenu.add(camera, "inModelView").name("In Model View").listen().onChange(function(model) {
                            camera.setInModelView(model);
                        });
                        */
                guiCameraMenu
                    .add(camera1, "doAutoRotate")
                    .name("Auto Rotate")
                    .listen()
                    .onChange(function (value) {
                        camera1.setAutoRotate(value);
                    });
                guiCameraMenu.open();

                // POINT-LIGHT-MENU
                const guiPointLightMenu = gui.addFolder("PointLight Menu");
                guiPointLightMenu
                    .add(pointLight, "visible")
                    .name("On")
                    .setValue(pointLight.visible)
                    .listen()
                    .onChange(function (value) {});
                guiPointLightMenu
                    .add(pointLight.position, "x")
                    .name("x")
                    .min(0)
                    .max(100)
                    .step(0.1)
                    .setValue(pointLight.position.y)
                    .listen()
                    .onChange(function (value) {});
                guiPointLightMenu
                    .add(pointLight.position, "y")
                    .name("y")
                    .min(0)
                    .max(100)
                    .step(0.1)
                    .setValue(pointLight.position.y)
                    .listen()
                    .onChange(function (value) {});
                guiPointLightMenu
                    .addColor(pointLight, "strColor")
                    .name("Color")
                    .setValue(pointLight.strColor)
                    .listen()
                    .onChange(function (value) {
                        pointLight.setColor(value);
                    });
                guiPointLightMenu
                    .add(pointLight, "intensity")
                    .name("Intensity")
                    .min(0)
                    .max(2.5)
                    .step(0.1)
                    .setValue(pointLight.intensity)
                    .listen()
                    .onChange(function (value) {});
                guiPointLightMenu.open();

                // READ JSON DATA
                readTextFile("./data.json", function (text) {
                    data = JSON.parse(text);
                    dataReady = true;
                });

                // DRAW SCENE IN A RENDER LOOP (ANIMATION)
                renderLoop();
            }

            function renderLoop() {
                stats.begin();
                renderer.render(scene, camera1); // DRAW THE SCENE GRAPH
                updateScene();
                stats.end();
                requestAnimationFrame(renderLoop);
            }

            function updateScene() {
                if (!window.multiview) {
                    camera1.aspect = window.innerWidth / window.innerHeight;
                    camera1.updateProjectionMatrix();
                    renderer.setViewport(
                        0,
                        0,
                        window.innerWidth,
                        window.innerHeight
                    );
                    renderer.setScissor(
                        0,
                        0,
                        window.innerWidth,
                        window.innerHeight
                    );
                    renderer.render(scene, camera1);
                } else {
                    // CAMERA 1
                    camera1.aspect =
                        window.innerWidth / 2 / (window.innerHeight / 2);
                    camera1.updateProjectionMatrix();
                    renderer.setViewport(
                        window.innerWidth / 2,
                        window.innerHeight / 2,
                        window.innerWidth / 2,
                        window.innerHeight / 2
                    );
                    renderer.setScissor(
                        window.innerWidth / 2,
                        window.innerHeight / 2,
                        window.innerWidth / 2,
                        window.innerHeight / 2
                    );
                    renderer.render(scene, camera1);

                    // CAMERA 2
                    camera2.aspect =
                        window.innerWidth / 2 / (window.innerHeight / 2);
                    camera2.updateProjectionMatrix();
                    renderer.setViewport(
                        0,
                        window.innerHeight / 2,
                        window.innerWidth / 2,
                        window.innerHeight / 2
                    );
                    renderer.setScissor(
                        0,
                        window.innerHeight / 2,
                        window.innerWidth / 2,
                        window.innerHeight / 2
                    );
                    renderer.render(scene, camera2);

                    // CAMERA 3
                    camera3.aspect =
                        window.innerWidth / 2 / (window.innerHeight / 2);
                    camera3.updateProjectionMatrix();
                    renderer.setViewport(
                        0,
                        0,
                        window.innerWidth / 2,
                        window.innerHeight / 2
                    );
                    renderer.setScissor(
                        0,
                        0,
                        window.innerWidth / 2,
                        window.innerHeight / 2
                    );
                    renderer.render(scene, camera3);

                    // CAMERA 4
                    camera4.aspect =
                        window.innerWidth / 2 / (window.innerHeight / 2);
                    camera4.updateProjectionMatrix();
                    renderer.setViewport(
                        window.innerWidth / 2,
                        0,
                        window.innerWidth / 2,
                        window.innerHeight / 2
                    );
                    renderer.setScissor(
                        window.innerWidth / 2,
                        0,
                        window.innerWidth / 2,
                        window.innerHeight / 2
                    );
                    renderer.render(scene, camera4);
                }

                if (dataReady) {
                    let xPlus = 0;
                    if (frameCounter < data.frames.length) {
                        for (
                            let i = 0;
                            i < data.frames[frameCounter].cars.length;
                            i++
                        ) {
                            const id = data.frames[frameCounter].cars[i].id;
                            const dir = data.frames[frameCounter].cars[i].dir;
                            if (dir === 180) {
                                xPlus = -5;
                            } else {
                                xPlus = 1;
                            }
                            const x =
                                data.frames[frameCounter].cars[i].x + xPlus;
                            const z = data.frames[frameCounter].cars[i].z;

                            let car = scene.getObjectByName(id);
                            if (!car) {
                                let car = new SportsCar(x, z, dir);
                                car.name = id;
                                scene.add(car);
                            } else {
                                car.setPosition(x, z);
                                car.setDirection(dir);
                                car.setOnFloor();
                            }
                        }

                        if (camera1.orbitControls.autoRotate) {
                            camera1.orbitControls.update();
                        }

                        /*
                                if(camera.inModelView) {
                                    camera.setInModelView(car);
                                }
                                */
                        frameCounter++;
                    }
                }
            }

            function readTextFile(file, callback) {
                var rawFile = new XMLHttpRequest();
                rawFile.overrideMimeType("application/json");
                rawFile.open("GET", file, true);
                rawFile.onreadystatechange = function () {
                    if (rawFile.readyState === 4 && rawFile.status == "200") {
                        callback(rawFile.responseText);
                    }
                };
                rawFile.send(null);
            }

            // EVENT LISTENERS & HANDLERS
            document.addEventListener("DOMContentLoaded", init);

            window.addEventListener(
                "resize",
                () => {
                    if (!window.multiview) {
                        camera1.aspect = window.innerWidth / window.innerHeight;
                        camera1.updateProjectionMatrix();
                        renderer.setSize(window.innerWidth, window.innerHeight);
                    } else {
                        // CAMERA 1
                        camera1.aspect =
                            window.innerWidth / 2 / (window.innerHeight / 2);
                        camera1.updateProjectionMatrix();
                        // CAMERA 2
                        camera2.aspect =
                            window.innerWidth / 2 / (window.innerHeight / 2);
                        camera2.updateProjectionMatrix();
                        // CAMERA 3
                        camera3.aspect =
                            window.innerWidth / 2 / (window.innerHeight / 2);
                        camera3.updateProjectionMatrix();
                        // CAMERA 4
                        camera4.aspect =
                            window.innerWidth / 2 / (window.innerHeight / 2);
                        camera4.updateProjectionMatrix();
                    }
                },
                false
            );

            class Camera extends THREE.PerspectiveCamera {
                constructor(
                    fov = 70,
                    aspect = window.innerWidth / window.innerHeight,
                    near = 0.01,
                    far = 10000.0
                ) {
                    super(fov, aspect, near, far);

                    this.perspectiveView = false;
                    this.topView = false;
                    this.sideView = false;
                    //this.inModelView = false;
                    this.doAutoRotate = false;

                    // CAMERA CONTROLS
                    this.orbitControls = new OrbitControls(
                        this,
                        renderer.domElement
                    );
                    this.orbitControls.update();
                }
                setPerspectiveView() {
                    this.position.set(-100, 100, 300);
                    this.orbitControls.target = new THREE.Vector3(0, 0, 0);
                    this.up.set(0, 1, 0);
                    this.orbitControls.update();

                    // DISABLE THE OTHER CAMERAS
                    this.topView = false;
                    this.frontView = false;
                    this.sideView = false;
                    this.inModelView = false;
                }
                setFrontView() {
                    this.position.set(0, 10, 260);
                    this.orbitControls.target = new THREE.Vector3(0, 0, 0);
                    this.up.set(0, 1, 0);
                    this.orbitControls.update();

                    // DISABLE THE OTHER CAMERAS
                    this.perspectiveView = false;
                    this.topView = false;
                    this.sideView = false;
                }
                setTopView() {
                    this.position.set(0, 425, 0);
                    this.orbitControls.target = new THREE.Vector3(0, 0, 0);
                    this.up.set(-1, 0, 0);
                    this.orbitControls.update();

                    // DISABLE THE OTHER CAMERAS
                    this.perspectiveView = false;
                    this.frontView = false;
                    this.sideView = false;
                    this.inModelView = false;
                }
                setSideView() {
                    this.position.set(240, 1.8, 0);
                    this.orbitControls.target = new THREE.Vector3(0, 0, 0);
                    this.up.set(0, 1, 0);
                    this.orbitControls.update();

                    // DISABLE THE OTHER CAMERAS
                    this.perspectiveView = false;
                    this.topView = false;
                    this.frontView = false;
                    this.inModelView = false;
                }
                /*
                        setInModelView(model) {
                            this.position.set(model.position.x - 0.5, model.position.y + 1.7, model.position.z);
                            this.orbitControls.target = new THREE.Vector3(model.position.x - 0.5, model.position.y + 1.7, model.position.z);
                            this.up.set(0, 1, 0);
                            this.orbitControls.update();

                            // DISABLE THE OTHER CAMERAS
                            this.perspectiveView = false;
                            this.topView = false;
                            this.frontView = false;
                            this.sideView = false;
                        }
                        */
                setAutoRotate(value) {
                    this.orbitControls.autoRotate = value;
                }
            }

            class PointLight extends THREE.PointLight {
                constructor(x = 0, z = 0, color = 0xfff4da, intensity = 2) {
                    super(color, intensity, x, z);
                    this.strColor = color;
                    this.visible = true;
                    this.x = x;
                    this.z = z;
                    this.position.set(this.x, 100, this.z);
                }
                setColor(strColor) {
                    this.color.setHex(strColor);
                }
            }

            class Axes extends THREE.AxesHelper {
                constructor(size = 10, visible = true) {
                    super(size);
                    this.size = size;
                    this.visible = visible;
                    this.position.set(0, 1, 0);
                }
                setVisible(value) {
                    this.visible = value;
                }
            }

            class Floor extends THREE.Group {
                constructor(size = 100) {
                    super();
                    this.size = size;
                    const geometry = new THREE.PlaneGeometry(size, size);
                    const material = new THREE.MeshBasicMaterial({
                        color: 0x787878,
                    });
                    this.mesh = new THREE.Mesh(geometry, material);
                    this.mesh.rotation.x = -Math.PI / 2;
                    // CHILDREN
                    this.add(this.mesh);
                }
                setVisible(value = true) {
                    this.visible = value;
                }
                setWireframe(value = true) {
                    this.material.wireframe = value;
                }
                setColor(color) {
                    this.mesh.material.color.setHex(color);
                }
            }

            class Cube extends THREE.Group {
                constructor(size = 1, color = 0xcc0000, wireColor = 0xffffff) {
                    super();
                    this.size = size;
                    this.color = color;
                    this.wireColor = wireColor;
                    this.doubleSide = false;
                    this.rotate = false;
                    const geometry = new THREE.BoxGeometry(size, size, size);
                    const material = new THREE.MeshPhongMaterial({ color });
                    const materialWire = new THREE.MeshPhongMaterial({
                        wireframe: true,
                        color: wireColor,
                    });
                    this.solid = new THREE.Mesh(geometry, material);
                    this.wire = new THREE.Mesh(geometry, materialWire);
                    // CHILDREN
                    this.add(this.solid);
                    this.add(this.wire);
                }
                setWireframe(value = true) {
                    //this.solid.setVisible(value);
                    this.wire.visible = value;
                }
                setColor(hexColor) {
                    this.color = hexColor;
                    this.solid.material.color.setHex(hexColor);
                }
                setWireColor(hexColor) {
                    this.wireColor = hexColor;
                    this.wire.material.color.setHex(hexColor);
                }
                setDoubleSide(value) {
                    this.doubleSide = value;
                    if (value) {
                        this.solid.material.side = THREE.DoubleSide;
                    } else {
                        this.solid.material.side = THREE.FrontSide;
                    }
                }
                setOnFloor() {
                    this.solid.geometry.computeBoundingBox();
                    const bBox = this.solid.geometry.boundingBox;
                    this.position.y = -bBox.min.y;
                }
            }

            class Car extends Cube {
                constructor(x = 0, z = 0, theta = Math.PI / 2) {
                    super(5, 0x00ff0);
                    this.x = x;
                    this.z = z;
                    this.theta = theta;
                    this.name;
                    this.setOnFloor();
                    this.position.set(x, 0, z);
                }
                setPosition(x, z) {
                    this.x = x;
                    this.z = z;
                    this.position.x = x;
                    this.position.z = z;
                }
                setDirection(dir) {
                    this.theta = dir;
                    this.rotation.y = (dir * Math.PI) / 180;
                }
                modelReady = true;
            }

            class SportsCar extends THREE.Group {
                constructor(
                    x = 0,
                    z = 0,
                    theta = Math.PI / 2,
                    objFileName = "./assets/obj/car5.obj"
                ) {
                    super();
                    this.x = x;
                    this.z = z;
                    this.theta = theta;
                    this.position.set(x, 0, z);
                    this.color = 0xcc0000;
                    this.wireColor = 0xffffff;
                    this.doubleSide = false;
                    this.rotate = false;
                    this.objFileName = objFileName;
                    this.loadOBJModel(objFileName);
                }
                loadOBJModel(objFileName) {
                    // instantiate a loader
                    const loader = new OBJLoader();
                    // load a resource
                    const model = this;
                    loader.load(
                        objFileName,
                        // called when resource is loaded
                        function (object) {
                            // SOLID
                            object.traverse(function (child) {
                                if (child.isMesh) {
                                    child.material =
                                        new THREE.MeshPhongMaterial({
                                            color: model.color,
                                        });
                                }
                            });
                            model.solid = object;
                            // WIRE
                            model.wire = object.clone();
                            model.wire.traverse(function (child) {
                                if (child.isMesh) {
                                    child.material =
                                        new THREE.MeshPhongMaterial({
                                            wireframe: true,
                                            color: model.wireColor,
                                        });
                                }
                            });
                            model.solid = object;
                            // WIRE
                            model.wire = object.clone();
                            model.wire.traverse(function (child) {
                                if (child.isMesh) {
                                    child.material =
                                        new THREE.MeshPhongMaterial({
                                            wireframe: true,
                                            color: model.wireColor,
                                        });
                                }
                            });
                            //model.rotation.y = Math.PI;
                            model.scale.set(3.5, 3.5, 3.5);
                            // CHILDREN
                            model.add(model.solid);
                            model.add(model.wire);
                            scene.add(model);
                            model.setOnFloor();

                            // MODEL-MENU
                            const guiSportCarMenu = gui.addFolder(
                                "Sport Car #" + model.name + " Menu"
                            );
                            // GUI-Model
                            guiSportCarMenu
                                .add(model, "visible")
                                .setValue(model.visible)
                                .name("Visible")
                                .listen()
                                .onChange(function (value) {});
                            guiSportCarMenu
                                .add(model.solid, "visible")
                                .setValue(model.solid.visible)
                                .name("Wireframe")
                                .listen()
                                .onChange(function (value) {});
                            guiSportCarMenu
                                .add(model, "doubleSide")
                                .setValue(model.doubleSide)
                                .name("Double Side")
                                .listen()
                                .onChange(function (value) {
                                    model.setDoubleSide(value);
                                });
                            guiSportCarMenu
                                .addColor(model, "color")
                                .name("Color")
                                .setValue(model.color)
                                .listen()
                                .onChange(function (value) {
                                    model.setColor(value);
                                });
                            guiSportCarMenu
                                .addColor(model, "wireColor")
                                .name("Wire Color")
                                .setValue(model.wireColor)
                                .listen()
                                .onChange(function (value) {
                                    model.setWireColor(value);
                                });
                            guiSportCarMenu
                                .add(model, "rotate")
                                .setValue(model.rotate)
                                .name("Rotate")
                                .listen()
                                .onChange(function (value) {});
                        },
                        // called when loading is in progresses
                        function (xhr) {
                            console.log(
                                (xhr.loaded / xhr.total) * 100 + "% loaded"
                            );
                        },
                        // called when loading has errors
                        function (error) {
                            console.log("An error happened " + error);
                        }
                    );
                }
                setColor(hexColor) {
                    this.color = hexColor;
                    this.solid.traverse(function (child) {
                        if (child.isMesh) {
                            child.material.color.setHex(hexColor);
                        }
                    });
                }
                setWireColor(hexColor) {
                    this.wireColor = hexColor;
                    this.wire.traverse(function (child) {
                        if (child.isMesh) {
                            child.material.color.setHex(hexColor);
                        }
                    });
                }
                setDoubleSide(value) {
                    this.doubleSide = value;
                    this.solid.traverse(function (child) {
                        if (child.isMesh) {
                            if (value) {
                                child.material.side = THREE.DoubleSide;
                            } else {
                                child.material.side = THREE.FrontSide;
                            }
                        }
                    });
                }
                setOnFloor() {
                    //const bBox = new THREE.Box3();
                    //bBox.setFromObject(this.solid);
                    //this.position.y = -bBox.min.y;
                    this.position.y = 7;
                }
                setPosition(x, z) {
                    this.x = x;
                    this.z = z;
                    this.position.x = x;
                    this.position.z = z;
                }
                setDirection(dir) {
                    this.theta = dir;
                    this.rotation.y = (dir * Math.PI) / 180;
                }
            }

            class Road extends THREE.Group {
                constructor(
                    x = 0,
                    z = 0,
                    size = 1000,
                    objFileName = "./assets/obj/LowPoly_city.obj"
                ) {
                    super();
                    this.wireframeBool = true;
                    this.textureBool = true;
                    this.color = 0xcc0000;
                    this.wireColor = 0xffffff;

                    this.objFileName = objFileName;
                    this.loadOBJModel(objFileName);
                    this.position.set(x, 12, z);
                }

                loadOBJModel(objFileName) {
                    // instantiate a loader
                    const loader = new OBJLoader();
                    // load a resource
                    const model = this;
                    loader.load(
                        objFileName,
                        // called when resource is loaded
                        function (object) {
                            // SOLID
                            object.traverse(function (child) {
                                if (child.isMesh) {
                                    child.material =
                                        new THREE.MeshBasicMaterial({
                                            color: model.color,
                                        });
                                }
                                //console.log(child.name);
                                // Remove all objects except Buildings
                                if (child.name === "ROAD") {
                                    child.material.color.setHex(0x787878);
                                } else if (child.name === "ROAD.Lines.12") {
                                    child.material.color.setHex(0xffffff);
                                } else if (
                                    child.name[0] === "C" ||
                                    child.name[0] === "A" ||
                                    child.name[0] === "B" ||
                                    child.name[0] === "T" ||
                                    child.name[0] === "t" ||
                                    child.name[0] === "H" ||
                                    child.name[0] === "L" ||
                                    child.name[0] === "M" ||
                                    child.name[0] === "S" ||
                                    child.name[0] === "F"
                                ) {
                                    child.visible = false;
                                }
                            });
                            model.solid = object;
                            // WIRE
                            model.wire = object.clone();
                            model.wire.traverse(function (child) {
                                if (child.isMesh) {
                                    child.material =
                                        new THREE.MeshBasicMaterial({
                                            wireframe: true,
                                            color: model.wireColor,
                                        });
                                }
                            });
                            //model.rotation.y = Math.PI;
                            model.scale.set(0.1, 0.1, 0.1);
                            // CHILDREN
                            model.add(model.solid);
                            model.add(model.wire);
                            scene.add(model);
                            //model.setOnFloor();
                        },
                        // called when loading is in progresses
                        function (xhr) {
                            console.log(
                                (xhr.loaded / xhr.total) * 100 + "% loaded"
                            );
                        },
                        // called when loading has errors
                        function (error) {
                            console.log("An error happened " + error);
                        }
                    );
                }

                setWireframe(value = true) {
                    this.wire.visible = value;
                }
            }

            class TrafficLightPoly extends THREE.Group {
                constructor(
                    x = 0,
                    z = 0,
                    size = 1000,
                    color = 0xcc0000,
                    objFileName = "./assets/obj/LowPoly_city.obj"
                ) {
                    super();
                    this.wireframeBool = true;
                    this.color = color;
                    //
                    this.objFileName = objFileName;
                    this.loadOBJModel(objFileName);
                    this.position.set(x, 13, z);
                }

                loadOBJModel(objFileName) {
                    // instantiate a loader
                    const loader = new OBJLoader();
                    // load a resource
                    const model = this;
                    loader.load(
                        objFileName,
                        // called when resource is loaded
                        function (object) {
                            // SOLID
                            object.traverse(function (child) {
                                if (child.isMesh) {
                                    child.material =
                                        new THREE.MeshBasicMaterial({
                                            color: model.color,
                                        });
                                }

                                // Remove all objects except TrafficLights
                                if (child.name.slice(0, 7) === "traffic") {
                                    switch (child.name) {
                                        case "traffic:light.2":
                                            child.material.color.setHex(
                                                0xacacac
                                            );
                                            break;
                                        default:
                                            child.visible = false;
                                            break;
                                    }
                                } else if (
                                    child.name[0] === "H" ||
                                    child.name[0] === "S" ||
                                    child.name[0] === "C" ||
                                    child.name[0] === "A" ||
                                    child.name[0] === "B" ||
                                    child.name[0] === "T" ||
                                    child.name[0] === "R" ||
                                    child.name[0] === "L" ||
                                    child.name[0] === "M" ||
                                    child.name[0] === "t" ||
                                    child.name[0] === "F"
                                ) {
                                    child.visible = false;
                                }
                            });
                            model.solid = object;
                            // WIRE
                            model.wire = object.clone();
                            model.wire.traverse(function (child) {
                                if (child.isMesh) {
                                    child.material =
                                        new THREE.MeshBasicMaterial({
                                            wireframe: true,
                                            color: model.wireColor,
                                        });
                                }
                            });
                            model.solid = object;
                            // WIRE
                            model.wire = object.clone();
                            model.wire.traverse(function (child) {
                                if (child.isMesh) {
                                    child.material =
                                        new THREE.MeshBasicMaterial({
                                            wireframe: true,
                                            color: model.wireColor,
                                        });
                                }
                            });
                            //model.rotation.y = Math.PI;
                            model.scale.set(0.1, 0.1, 0.1);
                            // CHILDREN
                            model.add(model.solid);
                            model.add(model.wire);
                            //scene.add(model);
                            //model.setOnFloor();
                        },
                        // called when loading is in progresses
                        function (xhr) {
                            console.log(
                                (xhr.loaded / xhr.total) * 100 + "% loaded"
                            );
                        },
                        // called when loading has errors
                        function (error) {
                            console.log("An error happened " + error);
                        }
                    );
                }
                setWireframe(value = true) {
                    this.wire.visible = value;
                }
            }

            class Buildings extends THREE.Group {
                constructor(
                    x = 0,
                    z = 0,
                    size = 1000,
                    color = 0xcc0000,
                    objFileName = "./assets/obj/LowPoly_city.obj"
                ) {
                    super();
                    this.wireframeBool = true;
                    this.color = color;
                    //
                    this.objFileName = objFileName;
                    this.loadOBJModel(objFileName);
                    //this.position.set(45, 12, -110);
                    this.position.set(x, 13, z);
                }

                loadOBJModel(objFileName) {
                    // instantiate a loader
                    const loader = new OBJLoader();
                    // load a resource
                    const model = this;
                    loader.load(
                        objFileName,
                        // called when resource is loaded
                        function (object) {
                            // SOLID
                            object.traverse(function (child) {
                                if (child.isMesh) {
                                    child.material =
                                        new THREE.MeshBasicMaterial({
                                            color: model.color,
                                        });
                                }

                                // Remove all objects except Buildings
                                if (child.name === "House") {
                                    child.material.color.setHex(0xff5a49);
                                    child.rotation.y = 90 * (Math.PI / 180);
                                    child.position.set(-950, 6, -600);
                                } else if (child.name === "House_1") {
                                    child.material.color.setHex(0xffb749);
                                    child.position.set(-1000, 6, -370);
                                } else if (child.name === "House_2") {
                                    child.material.color.setHex(0xff497b);
                                    child.rotation.y = 90 * (Math.PI / 180);
                                    child.position.set(-1800, 6, -100);
                                } else if (child.name === "Shop") {
                                    child.material.color.setHex(0x49a1ff);
                                } else if (
                                    child.name.slice(0, 6) === "Bushes"
                                ) {
                                    if (child.name === "Bushes.3_1") {
                                        child.visible = false;
                                    } else {
                                        child.material.color.setHex(0x31af48);
                                    }
                                } else if (
                                    child.name.slice(0, 7) === "Firtree"
                                ) {
                                    switch (child.name) {
                                        case "Firtree.3":
                                        case "Firtree.2":
                                        case "Firtree.1":
                                        case "Firtree":
                                        case "Firtree.4":
                                            child.visible = false;
                                            break;
                                        case "Firtree.47_1":
                                        case "Firtree.2_1":
                                        case "Firtree.4_1":
                                            child.material.color.setHex(
                                                0x0b975c
                                            );
                                            break;
                                        default:
                                            child.material.color.setHex(
                                                0x0a6840
                                            );
                                            break;
                                    }
                                } else if (child.name.slice(0, 5) === "Floor") {
                                    switch (child.name) {
                                        case "Floor":
                                            child.material.color.setHex(
                                                0xfbd660
                                            );
                                            child.scale.set(1.3, 0.1, 2.7);
                                            child.position.set(150, -113, 350);
                                            break;
                                        case "Floor_3":
                                            child.material.color.setHex(
                                                0x787878
                                            );
                                            child.position.set(0, 0, 120);
                                            child.scale.set(1, 1, 0.8);
                                            break;
                                        case "Floor.4_3":
                                            child.material.color.setHex(
                                                0xc0c0c0
                                            );
                                            child.position.set(0, 0, 120);
                                            child.scale.set(1, 1, 0.8);
                                            break;
                                        case "Floor_2":
                                            child.material.color.setHex(
                                                0xc0c0c0
                                            );
                                            child.position.set(100, 0, -1050);
                                            child.scale.set(0.8, 1, 1.75);
                                            break;
                                        default:
                                            child.visible = false;
                                            break;
                                    }
                                } else if (
                                    child.name[0] === "C" ||
                                    child.name[0] === "A" ||
                                    child.name[0] === "B" ||
                                    child.name[0] === "T" ||
                                    child.name[0] === "R" ||
                                    child.name[0] === "L" ||
                                    child.name[0] === "M" ||
                                    child.name[0] === "t" ||
                                    child.name[0] === "F"
                                ) {
                                    child.visible = false;
                                }
                            });
                            model.solid = object;
                            // WIRE
                            model.wire = object.clone();
                            model.wire.traverse(function (child) {
                                if (child.isMesh) {
                                    child.material =
                                        new THREE.MeshBasicMaterial({
                                            wireframe: true,
                                            color: model.wireColor,
                                        });
                                }
                            });
                            //model.rotation.y = Math.PI;
                            model.scale.set(0.1, 0.1, 0.1);
                            // CHILDREN
                            model.add(model.solid);
                            model.add(model.wire);
                            //scene.add(model);
                            //model.setOnFloor();
                        },
                        // called when loading is in progresses
                        function (xhr) {
                            console.log(
                                (xhr.loaded / xhr.total) * 100 + "% loaded"
                            );
                        },
                        // called when loading has errors
                        function (error) {
                            console.log("An error happened " + error);
                        }
                    );
                }
                setWireframe(value = true) {
                    this.wire.visible = value;
                }
            }

            class SkyBox extends THREE.Mesh {
                constructor(size = 1) {
                    super();
                    this.size = size;
                    this.doubleSide = false;
                    this.rotate = false;
                    this.geometry = new THREE.BoxGeometry(size, size, size);
                    const texture = new THREE.TextureLoader().load(
                        "./assets/img/happy-face.jpg"
                    );
                    //texture.wrapS = THREE.RepeatWrapping;
                    //texture.wrapT = THREE.RepeatWrapping;
                    //texture.repeat.set(1, 1);
                    this.material = [
                        new THREE.MeshPhongMaterial({
                            map: new THREE.TextureLoader().load(
                                "./assets/img/skybox/daylight_lf.png" // BIEN
                            ),
                            side: THREE.DoubleSide,
                        }),
                        new THREE.MeshPhongMaterial({
                            map: new THREE.TextureLoader().load(
                                "./assets/img/skybox/daylight_rt.png" // BIEN
                            ),
                            side: THREE.DoubleSide,
                        }),
                        new THREE.MeshPhongMaterial({
                            map: new THREE.TextureLoader().load(
                                "./assets/img/skybox/daylight_up.png" // BIEN
                            ),
                            side: THREE.DoubleSide,
                        }),
                        new THREE.MeshPhongMaterial({
                            map: new THREE.TextureLoader().load(
                                "./assets/img/skybox/daylight_dn.png" // BIEN
                            ),
                            side: THREE.DoubleSide,
                        }),
                        new THREE.MeshPhongMaterial({
                            map: new THREE.TextureLoader().load(
                                "./assets/img/skybox/daylight_ft.png" // MAL
                            ),
                            side: THREE.DoubleSide,
                        }),
                        new THREE.MeshPhongMaterial({
                            map: new THREE.TextureLoader().load(
                                "./assets/img/skybox/daylight_bk.png" // MAL
                            ),
                            side: THREE.DoubleSide,
                        }),
                    ];
                    this.scale.set(12000, 12000, 12000);
                    this.position.set(0, 0, 100);
                }
                setDoubleSide(value) {
                    this.doubleSide = value;
                    if (value) {
                        this.material.side = THREE.DoubleSide;
                    } else {
                        this.material.side = THREE.FrontSide;
                    }
                }
                setOnFloor() {
                    // this.geometry.computeBoundingBox();
                    // const bBox = this.geometry.boundingBox;
                    // this.position.y = -bBox.min.y;
                    this.position.y = 50;
                }
            }

            class BuildingsLow extends THREE.Group {
                constructor(x = 0, z = 0) {
                    super();
                    // Yellow Building
                    this.buildingLow1 = new Cube(30, 0xffb749);
                    this.buildingLow1.position.set(-55, 0, -150);
                    this.buildingLow1.scale.set(1, 2.25, 1);
                    this.buildingLow1.setOnFloor();

                    // Pink Building
                    this.buildingLow2 = new Cube(30, 0xff497b);
                    this.buildingLow2.position.set(-55, 0, -115);
                    this.buildingLow2.scale.set(0.7, 2, 0.7);
                    this.buildingLow2.setOnFloor();

                    // Orange Building
                    this.buildingLow3 = new Cube(30, 0xff5a49);
                    this.buildingLow3.position.set(-55, 0, -70);
                    this.buildingLow3.scale.set(0.7, 2.1, 1.3);
                    this.buildingLow3.setOnFloor();

                    // Blue Building
                    this.buildingLow4 = new Cube(30, 0x49a1ff);
                    this.buildingLow4.position.set(-63, 0, -20);
                    this.buildingLow4.scale.set(1, 0.5, 1.3);
                    this.buildingLow4.position.y = 8;

                    // Blue Building (Gray Floor)
                    this.buildingLow4Floor = new Cube(30, 0xc0c0c0);
                    this.buildingLow4Floor.position.set(-63, 0, -20);
                    this.buildingLow4Floor.scale.set(1.5, 0.07, 1.7);
                    this.buildingLow4Floor.position.y = 0;

                    this.add(this.buildingLow1);
                    this.add(this.buildingLow2);
                    this.add(this.buildingLow3);
                    this.add(this.buildingLow4);
                    this.add(this.buildingLow4Floor);

                    //scene.add(this);
                    this.position.set(x, 0, z);
                }
                setWireframe(value) {
                    this.buildingLow1.setWireframe(value);
                    this.buildingLow2.setWireframe(value);
                    this.buildingLow3.setWireframe(value);
                    this.buildingLow4.setWireframe(value);
                    this.buildingLow4Floor.setWireframe(value);
                }
            }

            class CompleteSceneHIGH extends THREE.Group {
                constructor() {
                    super();
                    this.buildingsHIGH1 = new Buildings(42, -108);

                    this.buildingsHIGH2 = new Buildings(42, 140);

                    this.buildingsHIGH3 = new Buildings(-49, 198);
                    this.buildingsHIGH3.rotation.y = 180 * (Math.PI / 180);

                    this.buildingsHIGH4 = new Buildings(-49, -50);
                    this.buildingsHIGH4.rotation.y = 180 * (Math.PI / 180);

                    this.add(this.buildingsHIGH1);
                    this.add(this.buildingsHIGH2);
                    this.add(this.buildingsHIGH3);
                    this.add(this.buildingsHIGH4);
                }
                setWireframe(value) {
                    this.buildingsHIGH1.setWireframe(value);
                    this.buildingsHIGH2.setWireframe(value);
                    this.buildingsHIGH3.setWireframe(value);
                    this.buildingsHIGH4.setWireframe(value);
                }
            }

            class CompleteSceneLOW extends THREE.Group {
                constructor() {
                    super();
                    this.buildingsCube1 = new BuildingsLow();
                    this.buildingsCube2 = new BuildingsLow(0, 250);
                    this.buildingsCube3 = new BuildingsLow(0, -155);
                    this.buildingsCube3.rotation.y = 180 * (Math.PI / 180);
                    this.buildingsCube4 = new BuildingsLow(-10, 85);
                    this.buildingsCube4.rotation.y = 180 * (Math.PI / 180);

                    this.add(this.buildingsCube1);
                    this.add(this.buildingsCube2);
                    this.add(this.buildingsCube3);
                    this.add(this.buildingsCube4);
                }
                setWireframe(value) {
                    this.buildingsCube1.setWireframe(value);
                    this.buildingsCube2.setWireframe(value);
                    this.buildingsCube3.setWireframe(value);
                    this.buildingsCube4.setWireframe(value);
                }
            }

            class ScenaryLOD extends THREE.LOD {
                constructor(size = 1000) {
                    super();

                    // Buildings LOW
                    this.low = new CompleteSceneLOW();
                    //this.low = new BuildingsLow();

                    this.high = new CompleteSceneHIGH();
                    //this.high = new Buildings(42, -100);

                    // CHILDREN
                    this.addLevel(this.high, 250);
                    this.addLevel(this.low, 450);
                }
                setWireframe(value) {
                    this.low.setWireframe(value);
                    this.high.setWireframe(value);
                }
            }

            class Scenary extends THREE.Group {
                constructor(size = 1000) {
                    super();
                    this.axes = new Axes(size);
                    this.floor = new Floor(size);

                    // LOD Elements
                    this.lodElements = new ScenaryLOD();
                    // Elements
                    this.road1 = new Road(45, -110);
                    this.road2 = new Road(45, 110);

                    this.trafficLight1 = new TrafficLightPoly(-15, 20);
                    this.trafficLight1.rotation.y = 90 * (Math.PI / 180);

                    this.trafficLight2 = new TrafficLightPoly(8, 75);
                    this.trafficLight2.rotation.y = -90 * (Math.PI / 180);

                    this.sky = new SkyBox();
                    this.sky.setOnFloor();

                    this.wireframeBool = true;
                    this.textureBool = true;
                    this.wireframeTraffic = true;
                    this.textureTraffic = true;

                    // CHILDREN
                    this.add(this.lodElements);
                    this.add(this.trafficLight1);
                    this.add(this.trafficLight2);
                    this.add(this.axes);
                    this.add(this.sky);
                    this.add(this.floor);
                }
                setWireframeScene(value) {
                    /*this.buildings1.setWireframe(value);
                    this.buildings2.setWireframe(value);
                    this.buildings3.setWireframe(value);
                    this.buildings4.setWireframe(value);*/
                    this.lodElements.setWireframe(value);
                    this.trafficLight1.setWireframe(value);
                    this.trafficLight2.setWireframe(value);
                    this.road1.setWireframe(value);
                    this.road2.setWireframe(value);
                }
            }
        </script>
    </body>
</html>
